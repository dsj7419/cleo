# Migration Guide: v2.3.0

## Overview

Version 2.3.0 introduces **task hierarchy** - a structured parent-child relationship system for organizing tasks into Epic → Task → Subtask relationships. This migration adds three new fields to tasks (`type`, `parentId`, `size`) and enables hierarchical filtering and tree views.

## What's New in v2.3.0

### Task Hierarchy Feature

- **Three-Level Structure**: Epic → Task → Subtask (max depth: 3)
- **Parent-Child Relationships**: Tasks can reference parent tasks via `parentId`
- **Type Classification**: Tasks can be classified as `epic`, `task`, or `subtask`
- **Scope-Based Sizing**: Optional `size` field (`small`, `medium`, `large`) for relative estimation
- **Sibling Limits**: Maximum 7 children per parent to prevent scope creep
- **Type Inference**: Automatically infers task type based on parent (task under epic, subtask under task)

### New CLI Flags

**Add Command**:
```bash
claude-todo add "Task" --type epic --size large
claude-todo add "Subtask" --parent T001 --size small
claude-todo add "Feature" --parent T001 --type task
```

**List Command**:
```bash
claude-todo list --type epic              # Filter by type
claude-todo list --parent T001            # Filter by parent ID
claude-todo list --children T001          # Show direct children of task
claude-todo list --tree                   # Hierarchical tree view
```

### Hierarchy Constraints

| Constraint | Value | Description |
|------------|-------|-------------|
| Max depth | 3 | Epic → Task → Subtask |
| Max siblings | 7 | Children per parent |
| Subtask children | 0 | Subtasks cannot have children |

### New Exit Codes

| Code | Name | Description |
|------|------|-------------|
| 10 | `EXIT_PARENT_NOT_FOUND` | Parent task ID doesn't exist |
| 11 | `EXIT_DEPTH_EXCEEDED` | Exceeds max depth of 3 levels |
| 12 | `EXIT_SIBLING_LIMIT` | Parent has max 7 children |
| 13 | `EXIT_INVALID_PARENT_TYPE` | Subtask cannot be parent |
| 14 | `EXIT_CIRCULAR_REFERENCE` | Task cannot be its own ancestor |
| 15 | `EXIT_ORPHAN_DETECTED` | Parent no longer exists |

## Schema Changes

### New Task Fields

**Before (v2.2.0)**:
```json
{
  "id": "T001",
  "title": "Implement feature",
  "status": "pending",
  "priority": "high"
}
```

**After (v2.3.0)**:
```json
{
  "id": "T001",
  "title": "Implement feature",
  "status": "pending",
  "priority": "high",
  "type": "task",
  "parentId": null,
  "size": "medium"
}
```

### Field Definitions

| Field | Type | Values | Default | Description |
|-------|------|--------|---------|-------------|
| `type` | string | `epic`, `task`, `subtask` | `task` | Task classification |
| `parentId` | string/null | Task ID (e.g., `T001`) | `null` | Parent task reference |
| `size` | string/null | `small`, `medium`, `large` | `null` | Scope-based sizing |

### Version Field

The schema version in `todo.json` updates from `2.2.0` to `2.3.0`:

```json
{
  "version": "2.3.0",
  "project": { ... },
  "tasks": [ ... ]
}
```

## Migration Process

### Automatic Migration (Recommended)

The migration system handles the transformation automatically:

```bash
# 1. Check current version
claude-todo migrate status

# 2. Run migration (creates backup automatically)
claude-todo migrate run

# 3. Verify migration
claude-todo validate
```

**Expected Output**:
```
Migrating .claude/todo.json from v2.2.0 to v2.3.0...
  Creating backup: .claude/backups/migration/pre-migration-20251217-120000/
  Backup created: .claude/backups/migration/pre-migration-20251217-120000/todo.json
  Step 1: Migrating to v2.3.0...
  - Converting tasks with epic-* labels to type: epic
  - Converting tasks with subtask-* labels to type: subtask
  - Adding type, parentId, size fields to all tasks
✓ Migration successful: .claude/todo.json

All files migrated successfully.
```

### Migration Steps (What Happens)

1. **Pre-Migration Backup**: Complete backup created in `.claude/backups/migration/`
2. **Label-Based Type Detection**:
   - Tasks with labels matching `epic-*` → `type: "epic"`
   - Tasks with labels matching `subtask-*` → `type: "subtask"`
   - All other tasks → `type: "task"`
3. **Field Addition**:
   - Add `type` field (default: `"task"`)
   - Add `parentId` field (default: `null`)
   - Add `size` field (default: `null`)
4. **Label Migration** (optional):
   - `epic-*` labels converted to `type: "epic"`
   - `subtask-*` labels converted to `type: "subtask"`
   - Original labels preserved for reference
5. **Version Update**: Update `version` field to `2.3.0`
6. **Validation**: Validate migrated file against v2.3.0 schema
7. **Logging**: Record migration in `.claude/.migration.log`

### Non-Interactive Migration

For CI/CD environments or scripts:

```bash
# Auto-migrate without confirmation
claude-todo migrate run --auto

# Skip backup creation (not recommended)
claude-todo migrate run --auto --no-backup
```

### Verify Before Migration

Check what will change:

```bash
# Current schema version
jq '.version' .claude/todo.json

# Check for hierarchy labels
jq '.tasks[] | select(.labels[]? | test("^(epic|subtask)-"))' .claude/todo.json

# Count tasks by potential type
jq '[.tasks[] | select(.labels[]? | test("^epic-"))] | length' .claude/todo.json
jq '[.tasks[] | select(.labels[]? | test("^subtask-"))] | length' .claude/todo.json
```

## Manual Migration Steps

If automatic migration fails or you prefer manual control:

### Step 1: Backup Current Data

```bash
# Create backup
cp -r .claude .claude.backup.$(date +%Y%m%d)

# Verify backup
ls -la .claude.backup.*
```

### Step 2: Add Hierarchy Fields to Tasks

```bash
# Add type, parentId, size to all tasks
jq '
  .tasks = [.tasks[] | . + {
    type: (if (.labels // []) | any(test("^epic-")) then "epic"
           elif (.labels // []) | any(test("^subtask-")) then "subtask"
           else "task" end),
    parentId: .parentId // null,
    size: .size // null
  }]
' .claude/todo.json > .claude/todo.json.tmp
```

### Step 3: Update Version Field

```bash
jq '.version = "2.3.0"' .claude/todo.json.tmp > .claude/todo.json.new
```

### Step 4: Validate and Replace

```bash
# Validate new file
jsonlint .claude/todo.json.new

# Verify task structure
jq '.tasks[0] | {type, parentId, size}' .claude/todo.json.new

# Replace original
mv .claude/todo.json.new .claude/todo.json
rm .claude/todo.json.tmp

# Validate with claude-todo
claude-todo validate
```

## Rollback Procedure

### Automatic Rollback

If migration created a backup:

```bash
# List available migration backups
ls -la .claude/backups/migration/

# Rollback using migrate command
claude-todo migrate rollback

# Or specify backup ID
claude-todo migrate rollback --backup-id migration_v2.2.0_20251217_120000
```

### Manual Rollback

If automatic rollback fails:

```bash
# 1. Identify backup directory
BACKUP_DIR=$(ls -td .claude/backups/migration/pre-migration-* | head -1)

# 2. Restore todo.json
cp "$BACKUP_DIR/todo.json" .claude/todo.json

# 3. Verify restoration
jq '.version' .claude/todo.json  # Should show "2.2.0"

# 4. Validate
claude-todo validate
```

## Post-Migration Setup

### Establish Parent-Child Relationships

After migration, establish hierarchy by setting parent IDs:

```bash
# Create an epic
claude-todo add "User Authentication System" --type epic --size large
# Returns: T050

# Create tasks under the epic
claude-todo add "Login endpoint" --parent T050 --size medium
claude-todo add "Registration endpoint" --parent T050 --size medium

# Create subtasks under a task
claude-todo add "Validate email format" --parent T051 --type subtask --size small
```

### Update Existing Tasks

```bash
# Convert existing task to epic
claude-todo update T001 --type epic

# Set parent relationship
claude-todo update T005 --parent T001

# Add size estimation
claude-todo update T005 --size medium
```

### View Hierarchy

```bash
# Tree view (hierarchical display)
claude-todo list --tree

# Filter by type
claude-todo list --type epic
claude-todo list --type subtask

# Show children of specific task
claude-todo list --children T001
```

## Breaking Changes

### New Exit Codes

Code previously may have assumed exit codes above 9 were unused. New hierarchy exit codes (10-15) now have specific meanings.

**Update error handling**:
```bash
# Before
if [ $? -ne 0 ]; then
    echo "Error occurred"
fi

# After
case $? in
    0) echo "Success" ;;
    10) echo "Parent task not found" ;;
    11) echo "Max depth exceeded (3 levels)" ;;
    12) echo "Max siblings exceeded (7 children)" ;;
    13) echo "Subtasks cannot have children" ;;
    14) echo "Circular reference detected" ;;
    15) echo "Orphaned task detected" ;;
    *) echo "Other error" ;;
esac
```

### Backward Compatibility

- **Read Operations**: v2.3.0 CLI can read v2.2.0 files (missing fields default to sensible values)
- **Write Operations**: After migration, v2.2.0 CLI may fail validation on v2.3.0 files
- **Recommendation**: Upgrade all team members to v2.3.0 after migration

## Troubleshooting

### Issue 1: "Parent task not found"

**Symptoms**:
```
ERROR: Parent task T999 not found
```

**Cause**: Attempting to set parent to non-existent task ID

**Solution**:
```bash
# Verify parent exists
claude-todo exists T999

# List all tasks to find correct ID
claude-todo list --all

# Use correct parent ID
claude-todo add "Task" --parent T001
```

### Issue 2: "Max depth exceeded"

**Symptoms**:
```
ERROR: Cannot create task - max depth of 3 exceeded
```

**Cause**: Attempting to create child of a subtask (depth 4)

**Solution**:
```bash
# Check parent's depth
claude-todo show T005

# If parent is a subtask, create sibling instead
claude-todo add "Task" --parent T004  # Parent of the subtask
```

### Issue 3: "Max siblings exceeded"

**Symptoms**:
```
ERROR: Cannot create task - parent T001 already has 7 children
```

**Cause**: Parent has reached maximum child limit

**Solution**:
```bash
# List children of parent
claude-todo list --children T001

# Complete or archive some children first
claude-todo complete T002
claude-todo archive

# Or create at a different level
claude-todo add "Task" --type epic  # Create new epic instead
```

### Issue 4: Tasks Missing type Field After Migration

**Symptoms**:
```bash
jq '.tasks[0].type' .claude/todo.json
# Returns: null
```

**Cause**: Migration didn't add type field

**Solution**:
```bash
# Re-run migration with force flag
claude-todo migrate run --force

# Or manually add type to tasks
jq '.tasks = [.tasks[] | .type = (.type // "task")]' \
  .claude/todo.json > .claude/todo.json.tmp
mv .claude/todo.json.tmp .claude/todo.json
```

### Issue 5: Orphaned Tasks After Parent Deletion

**Symptoms**:
```
WARNING: Task T005 has orphaned parentId T001 (parent not found)
```

**Cause**: Parent task was deleted or archived

**Solution**:
```bash
# Clear the parent reference
claude-todo update T005 --parent ""

# Or set new parent
claude-todo update T005 --parent T002
```

## Data Preservation Guarantees

The migration process preserves:

- All task data (id, title, description, status, etc.)
- Task metadata (timestamps, labels, dependencies)
- Phase assignments
- Focus state and session information
- All `_meta` fields (checksum, etc.)
- Archive and log files (unchanged in v2.3.0)

## Best Practices

### Before Migration

1. **Commit Changes**: Ensure git working directory is clean
   ```bash
   git status
   git commit -am "Pre-v2.3.0 migration checkpoint"
   ```

2. **Review Label Conventions**: Check if you use `epic-*` or `subtask-*` labels
   ```bash
   claude-todo labels
   ```

3. **Verify Backups**: Ensure backup system working
   ```bash
   claude-todo backup
   claude-todo backup --list
   ```

### During Migration

1. **Use Default Settings**: Let migration auto-detect types from labels
2. **Keep Backups**: Don't use `--no-backup` flag
3. **Monitor Output**: Watch for label-to-type conversions

### After Migration

1. **Validate Data**: Verify all tasks intact
   ```bash
   claude-todo validate
   claude-todo list --all
   ```

2. **Establish Hierarchy**: Set up parent-child relationships
   ```bash
   claude-todo list --type epic
   claude-todo update T005 --parent T001
   ```

3. **Test Operations**: Ensure hierarchy commands work
   ```bash
   claude-todo list --tree
   claude-todo list --children T001
   ```

## Migration Checklist

- [ ] Read this migration guide completely
- [ ] Review CHANGELOG.md for v2.3.0 changes
- [ ] Commit current work to git
- [ ] Create manual backup: `cp -r .claude .claude.backup.$(date +%Y%m%d)`
- [ ] Verify current version: `claude-todo migrate status`
- [ ] Run migration: `claude-todo migrate run`
- [ ] Verify migration success: `claude-todo validate`
- [ ] Check task types: `claude-todo list --type epic`
- [ ] Test hierarchy operations: `claude-todo list --tree`
- [ ] Establish parent-child relationships as needed
- [ ] Update team members to v2.3.0
- [ ] Clean up old backups (after 30 days)

## Summary

**What Changed**:
- New task fields: `type`, `parentId`, `size`
- New exit codes: 10-15 for hierarchy errors
- New CLI flags: `--type`, `--parent`, `--size`, `--children`, `--tree`
- Label-based type inference during migration

**Migration Method**:
- Automatic: `claude-todo migrate run`
- Manual: Follow manual migration steps above
- Rollback: `claude-todo migrate rollback`

**Safety**:
- Automatic backups before migration
- Label-to-type inference
- Validation after migration
- Rollback capability
- Data preservation guaranteed

**Next Steps**:
1. Run migration
2. Establish parent-child relationships
3. Explore new `--tree` and `--children` views
4. Organize tasks using hierarchy structure
